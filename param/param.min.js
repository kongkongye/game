window.Param=function(){var a=new Logger(LogConstant.SOURCE_PARAM),n={},t={},e={},r={},P={},o={},s={},T=function(a,n){var t=[];return n.forEach(function(a){a.type!==ParamConstant.TYPE_COMMON&&a.type!==ParamConstant.TYPE_PLAYER&&a.type!==ParamConstant.TYPE_PAGE&&a.type!==ParamConstant.TYPE_LIST||t.push({type:a.type,name:a.name})}),t},i=function(a,n,t){return n?n.replace(ParamConstant.REGEX,function(n,e,r){var P=r.split("|"),o=P[0];P.splice(0,1);var s=l(a,e,o,t);return f(s,P)}):n},C=function(a,n,t){if(n&&n.length>0){var e=Slot.getPageInfo(a),r=PageConfig.getPage(e.path).page;return Conn.send(PacketConstant.CLIENT200PARAM,{pageId:a,path:e.path,args:e.args,pageSize:r._size,page:e.page,contextPlugin:r._contextPlugin,contextKey:r._contextKey,clearList:t,params:n})}},l=function(a,n,T,i){var C,l=null;if(n===ParamConstant.TYPE_CONTEXT)return void 0===(C=m(a,T,i))&&(C=null),C;if(n===ParamConstant.TYPE_COMMON)l=t;else if(n===ParamConstant.TYPE_PLAYER)l=e;else if(n===ParamConstant.TYPE_PAGE)l=r[a];else if(n===ParamConstant.TYPE_LIST){if(-1!==i){var _=P[a];_&&(l=_[""+i])}}else if(n===ParamConstant.TYPE_CMD)l=o[a];else{if(n!==ParamConstant.TYPE_INPUT)throw'变量类型"'+n+'"无法处理!';l=s[a]}return l?(void 0===(C=l[T])&&(C=null),C):null},_=function(a,n){var T=n.type,i=n.name,C=n.value,l=n.index,_=null;if(T===ParamConstant.TYPE_COMMON)_=t;else if(T===ParamConstant.TYPE_PLAYER)_=e;else if(T===ParamConstant.TYPE_PAGE)(_=r[a])||(_={},r[a]=_);else if(T===ParamConstant.TYPE_LIST){var m=P[a];m||(m={},P[a]=m),(_=m[""+l])||(_={},m[""+l]=_)}else if(T===ParamConstant.TYPE_CMD)(_=o[a])||(_={},o[a]=_);else{if(T!==ParamConstant.TYPE_INPUT)throw'增加变量异常!变量类型"'+T+'"无法处理!';(_=s[a])||(_={},s[a]=_)}_[i]=C},m=function(a,n,t){var e=Slot.getPageInfo(a),r=PageConfig.getPage(e.path).page,P=null;if(n===ParamConstant.CONTEXT_PARAM_TITLE)P=i(a,r._title,t);else if(n===ParamConstant.CONTEXT_PARAM_HAS_CONTEXT)P=!!r._contextPlugin;else if(n===ParamConstant.CONTEXT_PARAM_LIST_INDEX)P=t;else if(n===ParamConstant.CONTEXT_PARAM_LIST_INDEX_ADD)P=t+1;else if(n===ParamConstant.CONTEXT_PARAM_LIST_POS)P=t+(e.page-1)*r._size;else if(n===ParamConstant.CONTEXT_PARAM_LIST_POS_ADD)P=t+(e.page-1)*r._size+1;else if(n===ParamConstant.CONTEXT_PARAM_LIST_PAGE)P=e.page;else if(n===ParamConstant.CONTEXT_PARAM_LIST_PAGE_SIZE)P=r._size;else if(n===ParamConstant.CONTEXT_PARAM_LIST_PAGE_AMOUNT)P=E(a);else if(n===ParamConstant.CONTEXT_PARAM_LIST_PAGE_MAX){var o=e.listTotal,s=r._size;P=o&&s?Common.getMaxPage(o,s):1}else n===ParamConstant.CONTEXT_PARAM_LIST_TOTAL&&(P=e.listTotal||0);return P},E=function(a){var n=P[a];if(!n)return 0;for(var t=-1;;)if(!n[""+ ++t])return t},f=function(a,t){return a||(a=""),t&&t.forEach(function(t){var e=Common.split(t,"-",2),r=e[0],P=e[1],o=n[r];if(o){var s=o[P];if(s){var T=s[a];void 0!==T&&(a=T)}}}),(a||"")+""},g=function(a){for(var n=1;n<arguments.length;n++){var t=arguments[n];if(t===ParamConstant.TYPE_PAGE)delete r[a];else if(t===ParamConstant.TYPE_LIST)delete P[a];else if(t===ParamConstant.TYPE_CMD)delete o[a];else{if(t!==ParamConstant.TYPE_INPUT)throw"页面类型"+t+"不允许清空!";delete s[a]}}},u=function(a){var n=e[a];void 0!==n&&null!==n&&(delete e[a],ParamHandler.addChange(null,ParamConstant.TYPE_PLAYER,a))};return Conn.register(PacketConstant.SERVER5160PIPES,{handle:function(a){var t=a.plugin,e=a.pipes;n[t]=e}}),Conn.register(PacketConstant.SERVER5200PARAM_RESULT,{handle:function(a){var n=a.pageId,t=(a.path,a.listTotal),e=a.clearList,r=a.params,P=Slot.getPageInfo(n);P.listTotal!==t&&(P.listTotal=t,ParamHandler.addChange(n,ParamConstant.TYPE_CONTEXT,ParamConstant.CONTEXT_PARAM_LIST_PAGE_AMOUNT),ParamHandler.addChange(n,ParamConstant.TYPE_CONTEXT,ParamConstant.CONTEXT_PARAM_LIST_PAGE_MAX),ParamHandler.addChange(n,ParamConstant.TYPE_CONTEXT,ParamConstant.CONTEXT_PARAM_LIST_TOTAL));var o=!1;e&&(o=!0,g(n,ParamConstant.TYPE_LIST),ParamHandler.addChange(n,ParamConstant.TYPE_LIST)),r.forEach(function(a){_(n,a),a.type===ParamConstant.TYPE_LIST&&(o=!0),e&&a.type===ParamConstant.TYPE_LIST||ParamHandler.addChange(n,a.type,a.name)}),Slot.checkInitDefault(n),o&&ParamHandler.addListChange(n,E(n))}}),{getParams:function(a){var n=[];if(a)for(;;){var t=ParamConstant.REGEX.exec(a);if(null===t)break;n.push({type:t[1],name:t[2].split("|")[0]})}return n},getLackParams:T,replaceParams:i,setCmdParams:function(a,n){if(n){o[a]=n;var t=o[a];for(var e in t)t.hasOwnProperty(e)&&ParamHandler.addChange(a,ParamConstant.TYPE_CMD,e)}},setInputParams:function(a,n){s[a]=n;for(var t in n)n.hasOwnProperty(t)&&ParamHandler.addChange(a,ParamConstant.TYPE_INPUT,t)},setInputParam:function(a,n,t){s[a]||(s[a]={}),(t=t.trim())?s[a][n]=t:delete s[a][n],Common.debounce(Constant.DebounceTypePrefix_InputParam+a+n,function(){ParamHandler.addChange(a,ParamConstant.TYPE_INPUT,n)},500)},refreshListParams:function(a){var n=[],t=Slot.getPageInfo(a);PageConfig.getNeededListParams(t.path).forEach(function(a){n.push({type:ParamConstant.TYPE_LIST,name:a})}),C(a,n,!0)},requestLackParams:function(a,n){var t=Slot.getPageInfo(a),e=PageConfig.getPage(t.path),r=T(0,e.params);r.length>0&&C(a,r,n)},requestParamsForCmd:function(a,n,t){if(t&&t.length>0)return Conn.send(PacketConstant.CLIENT200PARAM,{pageId:a,path:n,args:{},pageSize:1,page:1,clearList:!1,params:t},!0);var e=$.Deferred();return e.resolve(),e},clearPlayerParams:function(){var a=[];for(var n in e)e.hasOwnProperty(n)&&a.push(n);a.forEach(function(a){u(a)})},clearAll:function(n){g(n,ParamConstant.TYPE_PAGE,ParamConstant.TYPE_LIST,ParamConstant.TYPE_CMD,ParamConstant.TYPE_INPUT),a.info(LogType.DETAIL,"清空页面ID'{0}'相关的所有变量.",n)},getValue:l}}();